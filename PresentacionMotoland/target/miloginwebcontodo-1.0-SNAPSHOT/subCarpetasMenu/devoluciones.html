<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Devoluciones - MOTOLAND</title>
    <link rel="stylesheet" href="../style.css" />
    <style>
        .devolucion-container { max-width: 700px; margin: 0 auto; background:#f9f9f9; padding:30px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
        .form-group { margin-bottom:16px; }
        .form-group label { display:block; font-weight:600; margin-bottom:6px; }
        #tipo-devolucion, input[type="text"], textarea, select { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; background:white; }
        .ubicacion-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top:6px; }
        button[type="submit"] { background:#063a63; color:white; padding:12px 18px; border:none; border-radius:8px; cursor:pointer; font-weight:700; width:100%; }
        .status-message { text-align:center; padding:12px; margin-top:18px; border-radius:6px; display:none; }
        .status-message.success { background:#d4edda; color:#155724; }
        .status-message.error { background:#f8d7da; color:#721c24; }
    </style>
</head>
<body>
<div class="container">
    <header class="menu-header">
        <h1>Procesar Devoluciones</h1>
        <button onclick="window.location.href='../menu.html'">Volver al Menú</button>
    </header>

    <div class="devolucion-container">
        <form id="devolucion-form">
            <h2>Anular Transacción o Registrar Devolución</h2>

            <div class="form-group">
                <label for="tipo-devolucion">Tipo de Transacción a Anular:</label>
                <select id="tipo-devolucion" required>
                    <option value="">-- Selecciona un tipo --</option>
                    <option value="Venta">Venta</option>
                    <option value="Compra">Compra</option>
                </select>
            </div>

            <div class="form-group">
                <label for="codigo-transaccion">Código de la Transacción:</label>
                <input type="text" id="codigo-transaccion" placeholder="Ej: VENTA-101 o COMPRA-52" required />
            </div>

            <div class="form-group">
                <label for="producto">Producto (opcional):</label>
                <input id="producto" type="text" placeholder="Ej: PROD-22 o nombre del producto (opcional)" />
                <small style="color:#666;display:block;margin-top:6px;">Si quieres actualizar la ubicación del producto devuelto, indica el producto y selecciona Zona/Rack/Altura (los 3).</small>
            </div>

            <div class="form-group">
                <label>Ubicación del Producto (opcional):</label>
                <div class="ubicacion-grid">
                    <select id="ubic-zona">
                        <option value="">Zona</option>
                        <option value="1">P1</option>
                        <option value="2">P2</option>
                        <option value="3">P3</option>
                        <option value="4">P4</option>
                    </select>

                    <select id="ubic-rack">
                        <option value="">Rack</option>
                        <!-- genera racks 1..50 -->
                        <script>/* placeholder, se reemplaza con DOM ready */</script>
                    </select>

                    <select id="ubic-altura">
                        <option value="">Altura</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="motivo-devolucion">Motivo de la Devolución (Opcional):</label>
                <textarea id="motivo-devolucion" rows="3" placeholder="Ej: Producto incorrecto, cliente se arrepintió, etc."></textarea>
            </div>

            <button type="submit">Procesar Devolución</button>
        </form>

        <div id="status-message" class="status-message"></div>
    </div>
</div>

<script>
    // Poblar racks 1..50 dinámicamente
    (function populateRacks() {
        const rack = document.getElementById('ubic-rack');
        for (let i = 1; i <= 50; i++) {
            const opt = document.createElement('option');
            opt.value = String(i);
            opt.textContent = 'R' + i;
            rack.appendChild(opt);
        }
    })();

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('devolucion-form');
        const statusMessage = document.getElementById('status-message');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const tipo = document.getElementById('tipo-devolucion').value;
            const codigo = document.getElementById('codigo-transaccion').value.trim();
            const motivo = document.getElementById('motivo-devolucion').value.trim();
            const producto = document.getElementById('producto').value.trim();
            const zona = document.getElementById('ubic-zona').value;
            const rack = document.getElementById('ubic-rack').value;
            const altura = document.getElementById('ubic-altura').value;

            if (!tipo || !codigo) {
                alert('Completa tipo y código de la transacción.');
                return;
            }

            // Si se indicaron partes de ubicación, obligamos a que las 3 estén completas
            const anyUbic = zona || rack || altura;
            if (anyUbic && (!zona || !rack || !altura)) {
                alert('Si vas a especificar una ubicación, completa Zona, Rack y Altura.');
                return;
            }

            const payload = {
                tipo,
                codigo,
                motivo,
                producto: producto || null,
                ubicacion_zona: zona || null,
                ubicacion_rack: rack || null,
                ubicacion_altura: altura || null
            };

            // Deshabilitar botón para evitar doble envío
            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;

            try {
                const res = await fetch('../devoluciones', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json().catch(() => ({ status: 'error', message: 'Respuesta inesperada del servidor' }));

                statusMessage.textContent = data.message || (data.status === 'success' ? 'Procesado' : 'Error');
                statusMessage.className = 'status-message ' + (data.status === 'success' ? 'success' : 'error');
                statusMessage.style.display = 'block';

                if (data.status === 'success') {
                    form.reset();
                    // ocultar mensaje tras 4s
                    setTimeout(() => statusMessage.style.display = 'none', 4000);
                }
            } catch (err) {
                console.error(err);
                statusMessage.textContent = 'Error de conexión. Inténtalo de nuevo.';
                statusMessage.className = 'status-message error';
                statusMessage.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        });
    });
</script>
</body>
</html>
